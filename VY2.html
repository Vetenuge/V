<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VY2</title>
    <style>
        /* Basic styles */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background-color: #000;
            font-family: Arial, sans-serif;
        }
        /* Invisible activation line */
        #activationLine {
            position: fixed;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            z-index: 3;
            cursor: pointer;
            outline: none;
        }
        #activationLine.hidden {
            display: none;
        }
        /* Overlay to detect clicks outside the menu */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 1;
        }
        /* Side menu */
        #sideMenu {
            position: fixed;
            top: 0;
            left: -320px; /* Start hidden off-screen */
            width: 320px;
            height: 100%;
            background-color: #111;
            transition: left 0.3s;
            overflow-y: auto;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-sizing: border-box;
            padding: 0 10px;
        }
        #sideMenu.open {
            left: 0;
        }
        /* Side menu content */
        #playlistTitle {
            margin: 20px 0 10px 0;
            width: 100%;
            padding: 8px;
            font-size: 16px;
            box-sizing: border-box;
            text-align: center;
            background-color: #222;
            border: none;
            color: #fff;
        }
        /* Placeholder text color */
        #playlistTitle::placeholder {
            color: #888;
            opacity: 1; /* Ensure placeholder text is visible */
        }
        /* Disable tab focus on menu elements */
        #sideMenu * {
            outline: none;
        }
        /* Hover effect for input fields */
        #playlistTitle:hover {
            background-color: #333;
        }
        .controls, .import-export, .add-video {
            display: flex;
            justify-content: center;
            margin: 5px 0;
            width: 100%;
            align-items: center;
        }
        .controls select, .controls button, .import-export button, .add-video button {
            padding: 6px 8px;
            color: #fff;
            border: none;
            font-size: 14px;
            flex: 1;
            margin: 0 5px;
            background-color: #444;
            width: calc(50% - 10px);
            transition: background-color 0.3s;
            cursor: pointer;
        }
        /* Disable tab focus on buttons and select */
        .controls select, .controls button, .import-export button, .add-video button {
            outline: none;
        }
        /* Style for the select dropdown */
        .controls select {
            background-color: #444;
            color: #fff;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            text-align: center;
            cursor: pointer;
        }
        .controls select:hover {
            background-color: #555;
        }
        /* Hover effect for buttons */
        .controls button:hover, .import-export button:hover, .add-video button:hover {
            background-color: #555;
        }
        /* Clear VY button remains red */
        #clearButton {
            background-color: #ff4d4d;
        }
        /* Remove 'Choose file' button */
        #fileInput {
            display: none;
        }
        /* Video List Styling */
        #videoList {
            list-style: none;
            padding: 0;
            margin: 10px 0;
            color: #fff;
            width: 100%;
            flex-grow: 1;
            overflow-y: auto;
            box-sizing: border-box;
        }
        #videoList li {
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            width: 100%;
        }
        .video-item {
            display: flex;
            align-items: center;
            width: 100%;
            background-color: #222;
            padding: 6px;
            border-radius: 4px;
            box-sizing: border-box;
            transition: background-color 0.3s;
            cursor: pointer;
        }
        .video-item:hover {
            background-color: #333;
        }
        .video-item.current {
            background-color: #444; /* Highlight current video */
        }
        /* Delete Button */
        .remove-button {
            background-color: #ff4d4d;
            color: #fff;
            border: none;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 8px;
            flex-shrink: 0;
            transition: background-color 0.3s;
        }
        .remove-button:hover {
            background-color: #d43f3f;
        }
        /* Video Title */
        .video-title {
            font-size: 14px;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
        }
        /* Thumbnail */
        .thumbnail {
            width: 45px;
            height: 45px;
            background-color: #444;
            margin-left: 8px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        /* Item Number */
        .item-number {
            font-size: 14px;
            color: #aaa;
            margin-left: 8px;
            flex-shrink: 0;
        }
        /* Disable tab focus on video items */
        .video-item * {
            outline: none;
        }
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #444;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background-color: #222;
        }
        /* YouTube player container */
        #playerContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            transition: left 0.3s, width 0.3s;
            overflow: hidden;
            background-color: #000;
            display: none; /* Hide player initially */
        }
        #playerContainer.menu-open {
            left: 320px;
            width: calc(100% - 320px);
        }
        #player, #player iframe {
            width: 100%;
            height: 100%;
        }
        /* Arrow for the select dropdown */
        .controls select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D'http%3A//www.w3.org/2000/svg'%20width%3D'16'%20height%3D'16'%3E%3Cpolygon%20points%3D'0%2C0%2016%2C0%208%2C10'%20s[...]
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 12px 12px;
            padding-right: 20px;
        }
    </style>
</head>
<body>
    <!-- Invisible Activation Line -->
    <div id="activationLine"></div>
    <!-- Overlay -->
    <div id="overlay"></div>

    <!-- Side Menu -->
    <div id="sideMenu">
        <input type="text" id="playlistTitle" placeholder="Enter VY Title" value="" tabindex="-1">
        <div class="controls">
            <select id="sortOrder" tabindex="-1">
                <option value="custom">Custom</option>
                <option value="az">A-Z</option>
                <option value="za">Z-A</option>
                <option value="site-az">Site A-Z</option>
                <option value="site-za">Site Z-A</option>
                <option value="random">Randomize</option>
            </select>
            <button id="clearButton" tabindex="-1">Clear VY</button>
        </div>
        <div class="import-export">
            <button id="savePlaylistButton" tabindex="-1">Save VY</button>
            <button id="loadPlaylistButton" tabindex="-1">Load VY</button>
            <input type="file" id="fileInput" accept=".json" tabindex="-1">
        </div>
        <div class="add-video">
            <button id="addVideoButton" tabindex="-1">Add URL</button>
        </div>
        <ul id="videoList"></ul>
    </div>

    <!-- YouTube Player Container -->
    <div id="playerContainer">
        <div id="player"></div>
    </div>

    <!-- Load the YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        let player;
        let isMenuOpen = false; // Menu is closed by default
        let videoListData = []; // Stores {videoId, title, thumbnail, url}
        let currentIndex = -1;
        let customOrderData = []; // Stores the custom order

        const sideMenu = document.getElementById('sideMenu');
        const playerContainer = document.getElementById('playerContainer');
        const activationLine = document.getElementById('activationLine');
        const overlay = document.getElementById('overlay');
        const videoListElement = document.getElementById('videoList');

        // Disable tab focus on activation line
        activationLine.setAttribute('tabindex', '-1');

        // Function to toggle the menu
        function toggleMenu() {
            if (document.activeElement === activationLine || isMenuOpen) {
                isMenuOpen = !isMenuOpen;
                sideMenu.classList.toggle('open', isMenuOpen);
                activationLine.classList.toggle('hidden', isMenuOpen);
                overlay.style.display = isMenuOpen ? 'block' : 'none';
                adjustPlayerSize();
                saveMenuState();
            } else {
                // Only close the embed when menu is closed and activation line is not focused
                if (!isMenuOpen && document.activeElement !== activationLine) {
                    currentIndex = -1;
                    playerContainer.innerHTML = '';
                    playerContainer.style.display = 'none';
                }
            }
        }

        // Adjust the player size based on the menu state
        function adjustPlayerSize() {
            if (videoListData.length > 0) {
                playerContainer.style.display = 'block';
                if (isMenuOpen) {
                    playerContainer.classList.add('menu-open');
                } else {
                    playerContainer.classList.remove('menu-open');
                }
            } else {
                playerContainer.style.display = 'none';
            }
        }

        // Close menu when clicking outside
        overlay.addEventListener('click', () => {
            if (isMenuOpen) {
                isMenuOpen = false;
                sideMenu.classList.remove('open');
                activationLine.classList.remove('hidden');
                overlay.style.display = 'none';
                adjustPlayerSize();
                saveMenuState();
            }
        });

        // Editable VY Title
        const playlistTitleInput = document.getElementById('playlistTitle');
        playlistTitleInput.addEventListener('input', savePlaylistToLocal);

        // Sorting Dropdown
        const sortOrderSelect = document.getElementById('sortOrder');
        sortOrderSelect.addEventListener('change', () => {
            const selectedValue = sortOrderSelect.value;
            const previousVideo = videoListData[currentIndex] || null;
            switch (selectedValue) {
                case 'custom':
                    videoListData = [...customOrderData];
                    break;
                case 'az':
                    videoListData.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'za':
                    videoListData.sort((a, b) => b.title.localeCompare(a.title));
                    break;
                case 'site-az':
                    videoListData.sort((a, b) => {
                        const domainA = (new URL(a.url)).hostname;
                        const domainB = (new URL(b.url)).hostname;
                        return domainA.localeCompare(domainB);
                    });
                    break;
                case 'site-za':
                    videoListData.sort((a, b) => {
                        const domainA = (new URL(a.url)).hostname;
                        const domainB = (new URL(b.url)).hostname;
                        return domainB.localeCompare(domainA);
                    });
                    break;
                case 'random':
                    videoListData.sort(() => Math.random() - 0.5);
                    sortOrderSelect.value = 'custom'; // Set back to custom
                    customOrderData = [...videoListData];
                    break;
            }
            if (previousVideo) {
                currentIndex = videoListData.findIndex(video => video.url === previousVideo.url);
            }
            renderVideoList();
            savePlaylistToLocal();
        });

        // Clear VY Button
        const clearButton = document.getElementById('clearButton');
        clearButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear VY?')) {
                videoListData = [];
                customOrderData = [];
                currentIndex = -1;
                if (player) {
                    player.stopVideo();
                    playerContainer.style.display = 'none'; // Hide the player
                }
                renderVideoList();
                savePlaylistToLocal();
                adjustPlayerSize();
            }
        });

        // Add Video or URL
        const addVideoButton = document.getElementById('addVideoButton');
        addVideoButton.addEventListener('click', () => {
            const url = prompt('Enter Video or URL:');
            if (url && url.trim()) {
                addVideo(url.trim());
            }
        });

        async function addVideo(url) {
            const videoId = extractVideoId(url);

            if (videoListData.some(video => video.url === url)) {
                alert('This URL is already in the list.');
                return;
            }

            let videoData;
            if (videoId) {
                // If it's a YouTube URL
                const details = await fetchVideoDetails(videoId);
                if (!details) {
                    alert('Failed to fetch video details. The video might be private or unavailable.');
                    return;
                }
                videoData = {
                    videoId: videoId,
                    title: details.title,
                    thumbnail: details.thumbnail,
                    url: url
                };
            } else {
                // If it's any other URL
                let title = prompt('Enter a title for this URL (leave blank to use the URL itself):', url);
                title = title || url;
                videoData = {
                    videoId: null,
                    title: title,
                    thumbnail: `https://www.google.com/s2/favicons?domain=${new URL(url).hostname}`,
                    url: url
                };
            }

            videoListData.push(videoData); // Add to the end of the list
            customOrderData = [...videoListData]; // Update custom order
            renderVideoList();
            savePlaylistToLocal();

            // Start playing if first video
            if (videoListData.length === 1 && player) {
                currentIndex = 0;
                loadVideoByIndex(currentIndex);
            }
            adjustPlayerSize();
        }

        function renderVideoList() {
            videoListElement.innerHTML = '';
            videoListData.forEach((video, index) => {
                const li = document.createElement('li');
                li.dataset.index = index;

                const videoItem = document.createElement('div');
                videoItem.classList.add('video-item');
                if (index === currentIndex) {
                    videoItem.classList.add('current');
                }

                // Delete Button
                const removeButton = document.createElement('button');
                removeButton.classList.add('remove-button');
                removeButton.textContent = 'Delete';
                removeButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    videoListData.splice(index, 1);
                    customOrderData = [...videoListData];
                    if (index === currentIndex) {
                        currentIndex = -1;
                        if (videoListData.length > 0) {
                            currentIndex = 0;
                            loadVideoByIndex(currentIndex);
                        } else if (player) {
                            player.stopVideo();
                            playerContainer.style.display = 'none';
                        }
                    } else if (index < currentIndex) {
                        currentIndex--;
                    }
                    renderVideoList();
                    savePlaylistToLocal();
                    adjustPlayerSize();
                });

                // Video Title
                const title = document.createElement('div');
                title.classList.add('video-title');
                title.textContent = video.title;

                // Thumbnail
                const thumbnail = document.createElement('div');
                thumbnail.classList.add('thumbnail');
                if (video.thumbnail) {
                    const img = document.createElement('img');
                    img.src = video.thumbnail;
                    thumbnail.appendChild(img);
                }

                // Item Number
                const itemNumber = document.createElement('div');
                itemNumber.classList.add('item-number');
                itemNumber.textContent = (index + 1).toString();

                // Append elements in the specified order
                videoItem.appendChild(removeButton);
                videoItem.appendChild(title);
                videoItem.appendChild(thumbnail);
                videoItem.appendChild(itemNumber);

                li.appendChild(videoItem);

                // Click to play video
                videoItem.addEventListener('click', () => {
                    currentIndex = index;
                    loadVideoByIndex(currentIndex);
                    renderVideoList(); // Update highlight
                });

                videoListElement.appendChild(li);
            });

            // Hide the player if the VY is empty
            if (videoListData.length === 0 && player) {
                player.stopVideo();
                playerContainer.style.display = 'none';
            }
            savePlaylistToLocal();
        }

        // Initialize the player when the YouTube IFrame API is ready
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                playerVars: {
                    'autoplay': 1, // Enable autoplay
                    'controls': 1,
                    'showinfo': 0,
                    'rel': 0
                },
                events: {
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function loadVideoByIndex(index) {
            if (index < 0 || index >= videoListData.length) {
                return;
            }
            currentIndex = index;
            const videoId = videoListData[currentIndex].videoId;
            playerContainer.innerHTML = ''; // Clear previous content
            if (videoId) {
                playerContainer.innerHTML = '<div id="player"></div>';
                player = new YT.Player('player', {
                    height: '100%',
                    width: '100%',
                    videoId: videoId,
                    playerVars: {
                        'autoplay': 1, // Enable autoplay
                        'controls': 1,
                        'showinfo': 0,
                        'rel': 0
                    },
                    events: {
                        'onStateChange': onPlayerStateChange
                    }
                });
            } else {
                // For non-YouTube URLs, open in an iframe
                const nonYTUrl = videoListData[currentIndex].url;
                const iframe = document.createElement('iframe');
                iframe.src = nonYTUrl;
                iframe.width = '100%';
                iframe.height = '100%';
                iframe.style.border = 'none';
                playerContainer.appendChild(iframe);
            }
            renderVideoList(); // Update highlight

            // Ensure the player is visible
            playerContainer.style.display = 'block';
            adjustPlayerSize();
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                playNextVideo();
            }
        }

        function playNextVideo() {
            if (videoListData.length === 0) {
                return;
            }
            currentIndex = (currentIndex + 1) % videoListData.length;
            const nextVideoId = videoListData[currentIndex].videoId;
            if (nextVideoId) {
                // Autoplay the next YouTube video
                loadVideoByIndex(currentIndex);
            } else {
                // Embed non-YouTube URL
                playerContainer.innerHTML = ''; // Clear previous content
                const nonYTUrl = videoListData[currentIndex].url;
                const iframe = document.createElement('iframe');
                iframe.src = nonYTUrl;
                iframe.width = '100%';
                iframe.height = '100%';
                iframe.style.border = 'none';
                playerContainer.appendChild(iframe);
            }
        }

        // Extract video ID from YouTube URL
        function extractVideoId(url) {
            let videoId = null;
            try {
                const urlObj = new URL(url);
                if (urlObj.hostname.includes('youtu.be')) {
                    videoId = urlObj.pathname.slice(1);
                } else if (urlObj.hostname.includes('youtube.com')) {
                    videoId = urlObj.searchParams.get('v');
                } else {
                    const match = url.match(/v=([^&]+)/);
                    if (match) {
                        videoId = match[1];
                    }
                }

                // Remove any additional parameters
                if (videoId && videoId.includes('&')) {
                    videoId = videoId.split('&')[0];
                }
            } catch (e) {
                // Invalid URL
            }
            return videoId;
        }

        // Fetch video details from YouTube API
        async function fetchVideoDetails(videoId) {
            try {
                const response = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${videoId}`);
                const data = await response.json();
                if (data.error) {
                    console.error(data.error);
                    return null;
                }
                return {
                    title: data.title,
                    thumbnail: data.thumbnail_url
                };
            } catch (e) {
                console.error(e);
                return null;
            }
        }

        // Save and Load VY
        const savePlaylistButton = document.getElementById('savePlaylistButton');
        const loadPlaylistButton = document.getElementById('loadPlaylistButton');
        const fileInput = document.getElementById('fileInput');

        savePlaylistButton.addEventListener('click', savePlaylist);
        loadPlaylistButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', loadPlaylistFromFile);

        function savePlaylist() {
            const playlist = {
                title: playlistTitleInput.value,
                videos: videoListData.map(video => video.url),
                customOrder: customOrderData.map(video => video.url),
                titles: videoListData.reduce((acc, video) => {
                    if (!video.videoId) {
                        acc[video.url] = video.title;
                    }
                    return acc;
                }, {})
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(playlist));
            const downloadAnchor = document.createElement('a');
            downloadAnchor.setAttribute("href", dataStr);
            downloadAnchor.setAttribute("download", `${playlist.title || 'VY'}.json`);
            document.body.appendChild(downloadAnchor);
            downloadAnchor.click();
            downloadAnchor.remove();
        }

        function loadPlaylistFromFile(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const playlist = JSON.parse(e.target.result);
                    await loadPlaylistData(playlist);
                } catch (error) {
                    alert('Failed to load VY. Invalid file format.');
                }
            };
            reader.readAsText(file);
        }

        async function loadPlaylistData(playlist) {
            playlistTitleInput.value = playlist.title || '';
            videoListData = [];
            customOrderData = [];
            currentIndex = -1;

            for (const url of playlist.videos) {
                const videoId = extractVideoId(url);
                if (videoId) {
                    const details = await fetchVideoDetails(videoId);
                    if (details) {
                        videoListData.push({
                            videoId: videoId,
                            title: details.title,
                            thumbnail: details.thumbnail,
                            url: url
                        });
                    }
                } else {
                    const title = playlist.titles ? playlist.titles[url] : url;
                    videoListData.push({
                        videoId: null,
                        title: title,
                        thumbnail: `https://www.google.com/s2/favicons?domain=${new URL(url).hostname}`,
                        url: url
                    });
                }
            }
            customOrderData = [...videoListData];

            renderVideoList();
            savePlaylistToLocal();
            adjustPlayerSize();
        }

        // Persistent Storage using localStorage
        function savePlaylistToLocal() {
            const playlist = {
                title: playlistTitleInput.value,
                videos: videoListData.map(video => video.url),
                customOrder: customOrderData.map(video => video.url),
                titles: videoListData.reduce((acc, video) => {
                    if (!video.videoId) {
                        acc[video.url] = video.title;
                    }
                    return acc;
                }, {})
            };
            localStorage.setItem('savedPlaylist', JSON.stringify(playlist));
        }

        function loadPlaylistFromLocal() {
            const savedPlaylist = localStorage.getItem('savedPlaylist');
            if (savedPlaylist) {
                try {
                    const playlist = JSON.parse(savedPlaylist);
                    loadPlaylistData(playlist);
                } catch (e) {
                    console.error('Error loading saved VY:', e);
                }
            }
        }

        // Save menu state
        function saveMenuState() {
            localStorage.setItem('menuOpen', isMenuOpen ? 'true' : 'false');
        }

        function loadMenuState() {
            const menuState = localStorage.getItem('menuOpen');
            isMenuOpen = menuState === 'true';
            sideMenu.classList.toggle('open', isMenuOpen);
            activationLine.classList.toggle('hidden', isMenuOpen);
            overlay.style.display = isMenuOpen ? 'block' : 'none';
            adjustPlayerSize();
        }

        // Load VY and menu state on startup
        window.addEventListener('load', () => {
            loadPlaylistFromLocal();
            loadMenuState();
            // Ensure the initial state is a black screen with no embeds selected
            currentIndex = -1;
            playerContainer.innerHTML = '';
            playerContainer.style.display = 'none';
        });

        // Toggle Side Menu with Ctrl + Space and Activation Line Focus
        document.addEventListener('keydown', (event) => {
            if (event.code === 'Space' && event.ctrlKey) {
                event.preventDefault();
                if (!isMenuOpen && document.activeElement !== activationLine) {
                    // Close current embed if menu is not open and activation line is not focused
                    currentIndex = -1;
                    playerContainer.innerHTML = '';
                    playerContainer.style.display = 'none';
                } else {
                    toggleMenu();
                }
            }
        });

        activationLine.addEventListener('click', () => {
            activationLine.focus();
        });
    </script>
</body>
</html>